---
title: vue2æºç (1)-init
date: 2021-07-11
key: "vue2-source-code-1"
categories: Vue2æºç 
tags: vue 
keywords: vue2æºç  åˆå§‹åŒ– vue mixin
description: åˆ†ævue2çš„æºç ï¼Œç¬¬ä¸€ç« èŠ‚ï¼Œä¸»è¦è®²è¿°vueæ˜¯å¦‚ä½•å®Œæˆåˆå§‹åŒ–çš„ï¼Œå¦‚ä½•å¤„ç†mixinï¼Œstateï¼Œproviderï¼Œinjectç­‰ç­‰
---

import TOCInline from "@/components/TOCInline";

<TOCInline toc={props.toc}  toHeading={3} />

# å‰è¨€

ä½œä¸ºä¸€ä¸ªå·¥ä½œäº†4å¹´çš„å‰ç«¯èœé¸Ÿï¼Œæˆ‘æƒ³æ˜¯æ—¶å€™æ²‰æ·€ä¸€ä¸‹äº†ã€‚æ€æ¥æƒ³å»è¿˜æ˜¯è§‰å¾—ä»ä½¿ç”¨çš„æ¡†æ¶Vueå¼€å§‹ï¼Œäºæ˜¯æˆ‘æ‰“ç®—ä½¿ç”¨1-2ä¸ªæœˆçš„æ—¶é—´ï¼Œæ¥è¯¦ç»†é˜…è¯»Vueçš„æºç ï¼Œè™½ç„¶ä¹‹å‰ç²—ç•¥çš„é˜…è¯»è¿‡å‡ æ¬¡ã€‚

# ç›®æ ‡

ææ¸…æ¥šå„ä¸ªæ¨¡å—çš„ä½œç”¨ï¼Œæ¢³ç†Vueåˆå§‹åŒ–çš„ä¸»è¦æµç¨‹ã€‚

# é˜…è¯»å‰å‡†å¤‡

æ­¤æ¬¡é˜…è¯»æ˜¯åŸºäº`V2.6.14`

1.githubä¸‹è½½Vueæºç 

2.å®‰è£…åŒ…

3.åˆ›å»ºtest htmlæ–‡ä»¶

# ç›®å½•ç»“æ„è¯´æ˜

```
.
â”œâ”€â”€ BACKERS.md
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ benchmarks // æ€§èƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ big-table
â”‚   â”œâ”€â”€ dbmon
â”‚   â”œâ”€â”€ reorder-list
â”‚   â”œâ”€â”€ ssr
â”‚   â”œâ”€â”€ svg
â”‚   â””â”€â”€ uptime
â”œâ”€â”€ dist // ç¼–è¯‘åçš„ç›®å½•
â”œâ”€â”€ examples // ğŸŒ°
â”‚   â”œâ”€â”€ commits
â”‚   â”œâ”€â”€ elastic-header
â”‚   â”œâ”€â”€ firebase
â”‚   â”œâ”€â”€ grid
â”‚   â”œâ”€â”€ markdown
â”‚   â”œâ”€â”€ modal
â”‚   â”œâ”€â”€ move-animations
â”‚   â”œâ”€â”€ select2
â”‚   â”œâ”€â”€ svg
â”‚   â”œâ”€â”€ test.html
â”‚   â”œâ”€â”€ todomvc
â”‚   â””â”€â”€ tree
â”œâ”€â”€ flow // flowç”³æ˜
â”‚   â”œâ”€â”€ compiler.js
â”‚   â”œâ”€â”€ component.js
â”‚   â”œâ”€â”€ global-api.js
â”‚   â”œâ”€â”€ modules.js
â”‚   â”œâ”€â”€ options.js
â”‚   â”œâ”€â”€ ssr.js
â”‚   â”œâ”€â”€ vnode.js
â”‚   â””â”€â”€ weex.js
â”œâ”€â”€ package.json
â”œâ”€â”€ packages // ä¸€äº›é¢å¤–çš„åŒ…ï¼Œå¯ä»¥ç‹¬ç«‹å‘å¸ƒ
â”‚   â”œâ”€â”€ vue-server-renderer
â”‚   â”œâ”€â”€ vue-template-compiler
â”‚   â”œâ”€â”€ weex-template-compiler
â”‚   â””â”€â”€ weex-vue-framework
â”œâ”€â”€ scripts // ä¸€äº›è„šæœ¬ ä¾‹å¦‚ build å’Œ releaseçš„è„šæœ¬ å¯ä»¥é˜…è¯»çœ‹çœ‹
â”‚   â”œâ”€â”€ alias.js
â”‚   â”œâ”€â”€ build.js
â”‚   â”œâ”€â”€ config.js
â”‚   â”œâ”€â”€ feature-flags.js
â”‚   â”œâ”€â”€ gen-release-note.js
â”‚   â”œâ”€â”€ get-weex-version.js
â”‚   â”œâ”€â”€ git-hooks
â”‚   â”œâ”€â”€ release-weex.sh
â”‚   â”œâ”€â”€ release.sh
â”‚   â””â”€â”€ verify-commit-msg.js
â”œâ”€â”€ src // æ ¸å¿ƒæ¨¡å—ï¼Œé‡ç‚¹è¦è®²è§£çš„æ¨¡å—
â”‚   â”œâ”€â”€ compiler
â”‚   â”œâ”€â”€ core
â”‚   â”œâ”€â”€ platforms
â”‚   â”œâ”€â”€ server
â”‚   â”œâ”€â”€ sfc
â”‚   â””â”€â”€ shared
â”œâ”€â”€ test // æµ‹è¯•æ¨¡å—
â”‚   â”œâ”€â”€ e2e
â”‚   â”œâ”€â”€ helpers
â”‚   â”œâ”€â”€ ssr
â”‚   â”œâ”€â”€ unit
â”‚   â””â”€â”€ weex
â”œâ”€â”€ types // ts å£°æ˜
â”‚   â”œâ”€â”€ index.d.ts
â”‚   â”œâ”€â”€ options.d.ts
â”‚   â”œâ”€â”€ plugin.d.ts
â”‚   â”œâ”€â”€ test
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ typings.json
â”‚   â”œâ”€â”€ umd.d.ts
â”‚   â”œâ”€â”€ vnode.d.ts
â”‚   â””â”€â”€ vue.d.ts
â””â”€â”€ yarn.lock

```

ä¸ºäº†æ›´å¥½çš„è°ƒè¯•ï¼Œæˆ‘ä»¬åœ¨testä¸‹æ–°å»ºä¸€ä¸ª`test.html`ï¼Œç„¶åå¼•å…¥`dist/vue.js`

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./../dist/vue.js"></script>
```

å‡†å¤‡å·¥ä½œåŸºæœ¬å·²ç»å®Œæ¯•ï¼Œç°åœ¨å¼€å§‹çœ‹ä¸»æµç¨‹ã€‚

# åˆå§‹åŒ–
`src/core/index.js`ï¼Œ

 ```js
 import Vue from './instance/index'
import { initGlobalAPI } from './global-api/index'
import { isServerRendering } from 'core/util/env'
import { FunctionalRenderContext } from 'core/vdom/create-functional-component'
 ```
 
Vueä»`./instance/index`å¯¼å…¥

```js
import { initMixin } from './init'
import { stateMixin } from './state'
import { renderMixin } from './render'
import { eventsMixin } from './events'
import { lifecycleMixin } from './lifecycle'
import { warn } from '../util/index'

function Vue (options) {
  if (process.env.NODE_ENV !== 'production' &&
    !(this instanceof Vue)
  ) {
    warn('Vue is a constructor and should be called with the `new` keyword')
  }
  this._init(options)
}

initMixin(Vue)
stateMixin(Vue)
eventsMixin(Vue)
lifecycleMixin(Vue)
renderMixin(Vue)

export default Vue

```

åˆå§‹åŒ–ï¼Œä¸»è¦æ˜¯è¿™ä¸ª`_initæ–¹æ³•`ã€‚

å®ƒåœ¨`instance/init`ä¸­å®šä¹‰ï¼Œä¸€å…±åŒ…å«å››ä¸ªæ–¹æ³•`initMixin`, `initInternalComponent`, `resolveConstructorOptions`, `resolveModifiedOptions`
   
## initMixin

è¿™ä¸ªå‡½æ•°çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆå§‹åŒ–ä¸€äº›ä¸œè¥¿ï¼šå…·ä½“ä»€ä¹ˆå†…å®¹ä¼šåœ¨æ³¨é‡Šä¸­æ³¨æ˜ï¼›
```js
let uid = 0
export function initMixin (Vue: Class<Component>) {
  Vue.prototype._init = function (options?: Object) {
    const vm: Component = this
    // a uid
    // æ¯ä¸ªvueå®ä¾‹ éƒ½ä¼šç”Ÿæˆä¸€ä¸ªuidï¼Œä¸”è‡ªå¢
    vm._uid = uid++

    let startTag, endTag
    /* istanbul ignore if */
    if (process.env.NODE_ENV !== 'production' && config.performance && mark) {
      startTag = `vue-perf-start:${vm._uid}`
      endTag = `vue-perf-end:${vm._uid}`
      mark(startTag)
    }

    // a flag to avoid this being observed
    vm._isVue = true
    // merge options
    // åˆå¹¶options å­ç»„ä»¶å’Œæ ¹ç»„ä»¶åˆå¹¶é…ç½®é¡¹æœ‰ä¸åŒ
    // ä¼˜åŒ–å­ç»„ä»¶çš„optionsçš„åˆå¹¶
    if (options && options._isComponent) {
      // optimize internal component instantiation
      // since dynamic options merging is pretty slow, and none of the
      // internal component options needs special treatment.
      initInternalComponent(vm, options)
    } else {
      vm.$options = mergeOptions(
        resolveConstructorOptions(vm.constructor),
        options || {},
        vm
      )
    }
    /* istanbul ignore else */
    // è®¾ç½®ä»£ç†ï¼Œå°† vm å®ä¾‹ä¸Šçš„å±æ€§ä»£ç†åˆ° vm._renderProxy
    if (process.env.NODE_ENV !== 'production') {
      initProxy(vm)
    } else {
      vm._renderProxy = vm
    }
    // expose real self
    vm._self = vm
    // initLifecycle åˆå§‹åŒ– $parent, $root, $children, $refs
    initLifecycle(vm)
    // åˆå§‹åŒ–äº‹ä»¶
    initEvents(vm)
    
    // åˆå§‹åŒ– $slotsï¼Œ$scopedSlots, æŒ‚è½½$createElement
    // å°†$attrs, $listenersè®¾ç½®ä¸ºå“åº”å¼
    initRender(vm)
    
    // è°ƒç”¨ beforeCreate
    callHook(vm, 'beforeCreate')
    
    // åœ¨ data/props åˆå§‹åŒ–ä¹‹å‰ï¼Œåˆå§‹åŒ– injectï¼Œå¹¶ä¸”åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œåˆ‡æ¢ä¸ºé å“åº”å¼çŠ¶æ€
    // æ‰€ä»¥ injectçš„æ˜¯éå“åº”å¼çš„
    initInjections(vm) // resolve injections before data/props
    
    // åˆå§‹åŒ–æ•°æ® props, data, method, computedç­‰ç­‰
    initState(vm)
    
    // åˆå§‹åŒ–provide
    initProvide(vm) // resolve provide after data/props
    
    // è°ƒç”¨ created é’©å­
    callHook(vm, 'created')

    /* istanbul ignore if */
    if (process.env.NODE_ENV !== 'production' && config.performance && mark) {
      vm._name = formatComponentName(vm, false)
      mark(endTag)
      measure(`vue ${vm._name} init`, startTag, endTag)
    }
    // æŒ‚åœ¨åˆ°elä¸Š
    if (vm.$options.el) {
      vm.$mount(vm.$options.el)
    }
  }
}
```

## resolveConstructorOptions 
è¿™ä¸ªå‡½æ•°ä½œç”¨æ˜¯ï¼Œåˆå¹¶options

```js
export function resolveConstructorOptions (Ctor: Class<Component>) {
  let options = Ctor.options
  // æ˜¯å¦å­˜åœ¨çˆ¶ç±»ï¼Œå¦‚æœå­˜åœ¨çˆ¶ç±»å°±é€’å½’
  if (Ctor.super) {
    // é€’å½’åˆå¹¶options, å¦‚æœæ˜¯åŸºç±»çš„è¯
    const superOptions = resolveConstructorOptions(Ctor.super)
    // å¦‚æœoptionså‘ç”Ÿæ”¹å˜å°±éœ€è¦é‡æ–°åˆå¹¶
    const cachedSuperOptions = Ctor.superOptions
    if (superOptions !== cachedSuperOptions) {
      // super option changed,
      // need to resolve new options.
      Ctor.superOptions = superOptions
      // check if there are any late-modified/attached options (#4976)
      // å¦‚æœoptionså‘ç”Ÿæ”¹å˜å°±éœ€è¦é‡æ–°åˆå¹¶
      const modifiedOptions = resolveModifiedOptions(Ctor)
      // update base extend options
      // ç„¶åé‡æ–°åˆå¹¶
      if (modifiedOptions) {
        extend(Ctor.extendOptions, modifiedOptions)
      }
      options = Ctor.options = mergeOptions(superOptions, Ctor.extendOptions)
      if (options.name) {
        options.components[options.name] = Ctor
      }
    }
  }
  return options
}

```
é€šè¿‡debuggerï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åˆå¹¶åçš„`$options`å¦‚ä¸‹å›¾ï¼š

![init.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ad30464a3a5f411b972bee53d17decc4~tplv-k3u1fbpfcp-zoom-1.image)

åˆå¹¶äº†ï¼Œåˆå§‹åŒ–æ—¶å€™ä¼ å…¥çš„`options` ä»¥åŠ vue æ„é€ å‡½æ•°çš„ä¸€äº›å±æ€§

## resolveModifiedOptions

è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½æ˜¯ç”¨æ¥ å¦‚æœ superçš„optionå‘ç”Ÿäº†æ”¹å˜å°±é€šè¿‡éå†çš„æ–¹å¼ï¼Œæ–°æ—§ä¸ä¸€æ ·å°±é‡æ–°èµ‹å€¼
```js
function resolveModifiedOptions (Ctor: Class<Component>): ?Object {
  let modified
  const latest = Ctor.options
  const sealed = Ctor.sealedOptions
  for (const key in latest) {
    if (latest[key] !== sealed[key]) {
      if (!modified) modified = {}
      modified[key] = latest[key]
    }
  }
  return modified
}

```

# æ€»ç»“

new Vue()çš„ä¸»æµæˆï¼Œå®é™…ä¸Šçœ‹èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚

1.é€šè¿‡è°ƒç”¨`_init`è¿›è¡Œåˆå§‹åŒ–

2.åˆå§‹åŒ–`$parent, $root, $children, $refs`

3.åˆå§‹åŒ–ä¸€äº›è‡ªå®šä¹‰äº‹ä»¶ï¼ŒåŒ…æ‹¬æ–°æ—§äº‹ä»¶çš„å¯¹æ¯”å’Œæ›´æ–°

4.åˆå§‹åŒ– `\$slotsï¼Œ\$scopedSlots, $createElement`

5.è°ƒç”¨`beforeCreate`

6.åœ¨data/propsåˆå§‹åŒ–ä¹‹å‰ï¼Œåˆå§‹åŒ– `inject`ï¼Œå¹¶ä¸”åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œåˆ‡æ¢ä¸ºé å“åº”å¼çŠ¶æ€

7.åˆå§‹åŒ–æ•°æ® props, data, method, computedç­‰ç­‰

8.åˆå§‹åŒ–`provide`

9.è°ƒç”¨`created`é’©å­å‡½æ•°

10.å¦‚æœæœ‰`el`å°±è‡ªåŠ¨æŒ‚è½½ï¼Œå¦‚æœæ²¡æœ‰å°±éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `$mount`

# ä¸‹ä¸€èŠ‚é¢„å‘Š

å“åº”å¼åŸç†ï¼Œä»¥åŠå®ç°åŠç®€ç‰ˆVue
